<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="honeyarcade.admin.im.data.AdminImDataMapper">

	<select id="getStoreTotalCount" parameterType="honeyarcade.admin.im.data.AdminImDataVO" resultType="Integer">
		<if test="dateType == 1">
		<![CDATA[
			WITH A AS (
				select 
					  idx = 1
			   		, cast( replace(#{start_date}, '-', '') as date) as 'dt'
				union all
				select 
					  idx + 1
				   	, dateadd(d, 1, dt)
				from 
					A
				where 
					dt < cast( replace(#{end_date}, '-', '') as date)
			), owner_join as (
				select 
					  build_seq
					, count(owner_join_dt) as join_cnt
					, convert(char(10), owner_join_dt , 23) as 'owner_join_dt'
					, count(case when total_count - used_coupon ! = 0 then 1 end) as 'pre_owner'
				from 
					tb_owner	 
				left outer join tb_member
					on tb_owner.owner_id = tb_member.owner_id 
				left outer join (
									select 
										tb_pay.owner_id 
										, count(tb_pay_dtl.pay_seq) as total_count
										, count(case when tb_pay_dtl.pay_dtl_use = 5 then 1 end) as used_coupon
									from 
										tb_pay
									inner join tb_pay_dtl 
										on tb_pay.pay_seq = tb_pay_dtl.pay_seq
									inner join tb_owner
										on tb_pay.owner_id = tb_owner.owner_id 
										-- and tb_owner.del_flag = 'N'	 
									where 
										convert(char(10), tb_pay.pay_dt , 23) between #{start_date} and #{end_date}	
									group by
										tb_pay.owner_id 
								)t
					on tb_owner.owner_id = t.owner_id			
				where
					    tb_owner.owner_status != 4
					and tb_member.OWNER_JOIN_DT is not null
					and convert(char(10), owner_join_dt, 23) between #{start_date} and #{end_date}
				group by 
					build_seq , convert(char(10), owner_join_dt , 23)
			), owner_leave as (
				select
					build_seq
					, count(tb_member.member_id) as 'leave_cnt'
					, convert(char(10), tb_owner.mod_dt , 23) as 'owner_leave_dt'
				from 
					tb_owner	 
				left outer join tb_member
					on tb_owner.owner_id = tb_member.owner_id 
				where
					    tb_owner.owner_status != 4
					and tb_member.owner_join_dt is not null
					and tb_member.DEL_FLAG = 'Y'
					and tb_owner.DEL_FLAG = 'Y'
					and convert(char(10), tb_owner.mod_dt, 23) between #{start_date} and #{end_date}
				group by	
					build_seq , convert(char(10), tb_owner.mod_dt , 23)
			), temp as (
				select 
					  dt
					, isnull(owner_join.build_seq, owner_leave.build_seq) as build_seq
					, owner_join.join_cnt
					, owner_join_dt
					, pre_owner
					, owner_leave.leave_cnt
					, owner_leave_dt
				from 
					A
				left outer join owner_join
					on owner_join_dt = dt
				left join owner_leave
					on owner_leave_dt = dt
			), stat as (
				select 
					  convert(char(7), dt, 23) as dt
					, build_seq
					, sum(join_cnt) as join_cnt
					, sum(pre_owner) as pre_owner
					, isnull(sum(leave_cnt),0) as leave_cnt
				from 
					temp where build_seq != ''
				group by convert(char(7), dt, 23) , build_seq 
			)
		]]>
		
		<![CDATA[	
			select 
				  count(*)
			from 
				stat
			inner join tb_build
				on stat.build_seq = tb_build.build_seq 
				and tb_build.del_flag = 'N'
			inner join tb_dong
				on tb_dong.dong_seq = tb_build.dong_seq 
				and tb_dong.del_flag = 'N'
			inner join tb_sigungu
				on tb_sigungu.sigungu_seq = tb_dong.sigungu_seq 
				and tb_sigungu.del_flag = 'N'
			inner join tb_sido
				on tb_sigungu.sido_seq = tb_sido.sido_seq 
				and tb_sido.del_flag = 'N'	
		]]>
		<if test="type == 'search'">
			<if test="sido_seq != null">
				<![CDATA[
					and tb_sido.sido_seq = #{sido_seq}
				]]>
			</if>
	
			<if test="sigungu_seq != null">
				<![CDATA[
					and tb_sigungu.sigungu_seq = #{sigungu_seq}
				]]>
			</if>
	
			<if test="dong_seq != null">
				<![CDATA[
					and tb_dong.dong_seq = #{dong_seq}
				]]>
			</if>
		</if>
		<if test="admin_grade == 3">
			and tb_build.build_seq in (select tb_admin_grade.build_seq from tb_admin_grade where tb_admin_grade.admin_id = #{admin_id} and tb_admin_grade.del_flag = 'N')
		</if>			
		option (maxrecursion 0)	
		</if>
		<if test="dateType == 2">
		<![CDATA[
			WITH A AS (
				select 
					  idx = 1
			   		, cast( replace(#{start_date}, '-', '') as date) as 'dt'
				union all
				select 
					  idx + 1
				   	, dateadd(d, 1, dt)
				from 
					A
				where 
					dt < cast( replace(#{end_date}, '-', '') as date)
			), owner_join as (
				select 
					  build_seq
					, count(owner_join_dt) as join_cnt
					, convert(char(10), owner_join_dt , 23) as 'owner_join_dt'
					, count(case when total_count - used_coupon ! = 0 then 1 end) as 'pre_owner'
				from 
					tb_owner	 
				left outer join tb_member
					on tb_owner.owner_id = tb_member.owner_id 
				left outer join (
									select 
										tb_pay.owner_id 
										, count(tb_pay_dtl.pay_seq) as total_count
										, count(case when tb_pay_dtl.pay_dtl_use = 5 then 1 end) as used_coupon
									from 
										tb_pay
									inner join tb_pay_dtl 
										on tb_pay.pay_seq = tb_pay_dtl.pay_seq
									inner join tb_owner
										on tb_pay.owner_id = tb_owner.owner_id 
										-- and tb_owner.del_flag = 'N'	 
									where 
										convert(char(10), tb_pay.pay_dt , 23) between #{start_date} and #{end_date}	
									group by
										tb_pay.owner_id 
								)t
					on tb_owner.owner_id = t.owner_id			
				where
					    tb_owner.owner_status != 4
					and tb_member.OWNER_JOIN_DT is not null
					and convert(char(10), owner_join_dt, 23) between #{start_date} and #{end_date}
				group by 
					build_seq , convert(char(10), owner_join_dt , 23)
			), owner_leave as (
				select
					build_seq
					, count(tb_member.member_id) as 'leave_cnt'
					, convert(char(10), tb_owner.mod_dt , 23) as 'owner_leave_dt'
				from 
					tb_owner	 
				left outer join tb_member
					on tb_owner.owner_id = tb_member.owner_id 
				where
					    tb_owner.owner_status != 4
					and tb_member.owner_join_dt is not null
					and tb_member.DEL_FLAG = 'Y'
					and tb_owner.DEL_FLAG = 'Y'
					and convert(char(10), tb_owner.mod_dt, 23) between #{start_date} and #{end_date}
				group by	
					build_seq , convert(char(10), tb_owner.mod_dt , 23)
			), temp as (
				select 
					  dt
					, isnull(owner_join.build_seq, owner_leave.build_seq) as build_seq
					, owner_join.join_cnt
					, owner_join_dt
					, pre_owner
					, owner_leave.leave_cnt
					, owner_leave_dt
				from 
					A
				left outer join owner_join
					on owner_join_dt = dt
				left join owner_leave
					on owner_leave_dt = dt
			), stat as (
				select 
					  convert(char(10), dt, 23) as dt
					, build_seq
					, sum(join_cnt) as join_cnt
					, sum(pre_owner) as pre_owner
					, isnull(sum(leave_cnt),0) as leave_cnt
				from 
					temp where build_seq != ''
				group by convert(char(10), dt, 23) , build_seq 
			)
		]]>
		
		<![CDATA[	
			select 
				  count(*)
			from 
				stat
			inner join tb_build
				on stat.build_seq = tb_build.build_seq 
				and tb_build.del_flag = 'N'
			inner join tb_dong
				on tb_dong.dong_seq = tb_build.dong_seq 
				and tb_dong.del_flag = 'N'
			inner join tb_sigungu
				on tb_sigungu.sigungu_seq = tb_dong.sigungu_seq 
				and tb_sigungu.del_flag = 'N'
			inner join tb_sido
				on tb_sigungu.sido_seq = tb_sido.sido_seq 
				and tb_sido.del_flag = 'N'	
		]]>
		<if test="type == 'search'">
			<if test="sido_seq != null">
				<![CDATA[
					and tb_sido.sido_seq = #{sido_seq}
				]]>
			</if>
	
			<if test="sigungu_seq != null">
				<![CDATA[
					and tb_sigungu.sigungu_seq = #{sigungu_seq}
				]]>
			</if>
	
			<if test="dong_seq != null">
				<![CDATA[
					and tb_dong.dong_seq = #{dong_seq}
				]]>
			</if>
		</if>
		<if test="admin_grade == 3">
					and tb_build.build_seq in (select tb_admin_grade.build_seq from tb_admin_grade where tb_admin_grade.admin_id = #{admin_id} and tb_admin_grade.del_flag = 'N')
		</if>	
		option (maxrecursion 0)			
		</if>
	</select>
	
	<select id="getStoreList" parameterType="honeyarcade.admin.im.data.AdminImDataVO" resultType="honeyarcade.admin.im.data.AdminImDataVO">
		<if test="dateType == 1">
		<![CDATA[
			WITH A AS (
				select 
					  idx = 1
			   		, cast( replace(#{start_date}, '-', '') as date) as 'dt'
				union all
				select 
					  idx + 1
				   	, dateadd(d, 1, dt)
				from 
					A
				where 
					dt < cast( replace(#{end_date}, '-', '') as date)
			), owner_join as (
				select 
					  build_seq
					, count(owner_join_dt) as join_cnt
					, convert(char(10), owner_join_dt , 23) as 'owner_join_dt'
					, count(case when total_count - used_coupon ! = 0 then 1 end) as 'pre_owner'
				from 
					tb_owner	 
				left outer join tb_member
					on tb_owner.owner_id = tb_member.owner_id 
				left outer join (
									select 
										tb_pay.owner_id 
										, count(tb_pay_dtl.pay_seq) as total_count
										, count(case when tb_pay_dtl.pay_dtl_use = 5 then 1 end) as used_coupon
									from 
										tb_pay
									inner join tb_pay_dtl 
										on tb_pay.pay_seq = tb_pay_dtl.pay_seq 
									inner join tb_owner
										on tb_pay.owner_id = tb_owner.owner_id 
										-- and tb_owner.del_flag = 'N'	
									where 
										convert(char(10), tb_pay.pay_dt , 23) between #{start_date} and #{end_date}	
									group by
										tb_pay.owner_id 
								)t
					on tb_owner.owner_id = t.owner_id			
				where
					    tb_owner.owner_status != 4
					and tb_member.OWNER_JOIN_DT is not null
					and convert(char(10), owner_join_dt, 23) between #{start_date} and #{end_date}
				group by 
					build_seq , convert(char(10), owner_join_dt , 23)
			), owner_leave as (
				select
					build_seq
					, count(tb_member.member_id) as 'leave_cnt'
					, convert(char(10), tb_owner.mod_dt , 23) as 'owner_leave_dt'
				from 
					tb_owner	 
				left outer join tb_member
					on tb_owner.owner_id = tb_member.owner_id 
				where
					    tb_owner.owner_status != 4
					and tb_member.owner_join_dt is not null
					and tb_member.DEL_FLAG = 'Y'
					and tb_owner.DEL_FLAG = 'Y'
					and convert(char(10), tb_owner.mod_dt, 23) between #{start_date} and #{end_date}
				group by	
					build_seq , convert(char(10), tb_owner.mod_dt , 23)
			), temp as (
				select 
					  dt
					, isnull(owner_join.build_seq, owner_leave.build_seq) as build_seq
					, owner_join.join_cnt
					, owner_join_dt
					, pre_owner
					, owner_leave.leave_cnt
					, owner_leave_dt
				from 
					A
				left outer join owner_join
					on owner_join_dt = dt
				left join owner_leave
					on owner_leave_dt = dt
			), stat as (
				select 
					 convert(char(7), dt, 23) as dt
					, build_seq
					, isnull(sum(join_cnt), 0) as join_cnt
					, isnull(sum(pre_owner), 0) as pre_owner
					, isnull(sum(leave_cnt),0) as leave_cnt
				from 
					temp where build_seq != ''
				group by 
					convert(char(7), dt, 23) , build_seq 
			), cnt as (
				select
					build_seq
			  	 , count(ho_cnt) as ho_cnt
				from
					(
						select 
						  build_seq 
						, count(store_ho) as ho_cnt 
						from 
							tb_owner 
						where 
							owner_status !=4  
						group by 
							build_seq, store_ho
						) ss
					group by 
						build_seq
			), page as (
				select 
					  row_number () over(order by dt desc) as row_num
					, dt
					, tb_build.build_name
					, join_cnt
					, pre_owner
					, leave_cnt
					, tb_sido.sido_name
					, tb_sigungu.sigungu_name
					, tb_dong.dong_name
					, cnt.ho_cnt
				from 
					stat
				inner join tb_build
					on stat.build_seq = tb_build.build_seq 
					and tb_build.del_flag = 'N'
				inner join tb_dong
					on tb_dong.dong_seq = tb_build.dong_seq 
					and tb_dong.del_flag = 'N'
				inner join tb_sigungu
					on tb_sigungu.sigungu_seq = tb_dong.sigungu_seq 
					and tb_sigungu.del_flag = 'N'
				inner join tb_sido
					on tb_sigungu.sido_seq = tb_sido.sido_seq 
					and tb_sido.del_flag = 'N'	
				inner join cnt
					on stat.build_seq = cnt.build_seq	
				
			]]>
			<if test="type == 'search'">
				<if test="sido_seq != null">
					<![CDATA[
						and tb_sido.sido_seq = #{sido_seq}
					]]>
				</if>
		
				<if test="sigungu_seq != null">
					<![CDATA[
						and tb_sigungu.sigungu_seq = #{sigungu_seq}
					]]>
				</if>
		
				<if test="dong_seq != null">
					<![CDATA[
						and tb_dong.dong_seq = #{dong_seq}
					]]>
				</if>	
			</if>
			<if test="admin_grade == 3">
				and tb_build.build_seq in (select tb_admin_grade.build_seq from tb_admin_grade where tb_admin_grade.admin_id = #{admin_id} and tb_admin_grade.del_flag = 'N')
			</if>			
			)
			select
				*
			from
				page
			where
				row_num between #{start_num} and #{end_num}
			option (maxrecursion 0)		
		</if>
		<if test="dateType == 2">
		<![CDATA[
			WITH A AS (
				select 
					  idx = 1
			   		, cast( replace(#{start_date}, '-', '') as date) as 'dt'
				union all
				select 
					  idx + 1
				   	, dateadd(d, 1, dt)
				from 
					A
				where 
					dt < cast( replace(#{end_date}, '-', '') as date)
			), owner_join as (
				select 
					  build_seq
					, count(owner_join_dt) as join_cnt
					, convert(char(10), owner_join_dt , 23) as 'owner_join_dt'
					, count(case when total_count - used_coupon ! = 0 then 1 end) as 'pre_owner'
				from 
					tb_owner	 
				left outer join tb_member
					on tb_owner.owner_id = tb_member.owner_id 
				left outer join (
									select 
										tb_pay.owner_id 
										, count(tb_pay_dtl.pay_seq) as total_count
										, count(case when tb_pay_dtl.pay_dtl_use = 5 then 1 end) as used_coupon
									from 
										tb_pay
									inner join tb_pay_dtl 
										on tb_pay.pay_seq = tb_pay_dtl.pay_seq 
									inner join tb_owner
										on tb_pay.owner_id = tb_owner.owner_id 
										-- and tb_owner.del_flag = 'N'	
									where 
										convert(char(10), tb_pay.pay_dt , 23) between #{start_date} and #{end_date}	
									group by
										tb_pay.owner_id 
								)t
					on tb_owner.owner_id = t.owner_id			
				where
					    tb_owner.owner_status != 4
					and tb_member.OWNER_JOIN_DT is not null
					and convert(char(10), owner_join_dt, 23) between #{start_date} and #{end_date}
				group by 
					build_seq , convert(char(10), owner_join_dt , 23)
			), owner_leave as (
				select
					build_seq
					, count(tb_member.member_id) as 'leave_cnt'
					, convert(char(10), tb_owner.mod_dt , 23) as 'owner_leave_dt'
				from 
					tb_owner	 
				left outer join tb_member
					on tb_owner.owner_id = tb_member.owner_id 
				where
					    tb_owner.owner_status != 4
					and tb_member.owner_join_dt is not null
					and tb_member.DEL_FLAG = 'Y'
					and tb_owner.DEL_FLAG = 'Y'
					and convert(char(10), tb_owner.mod_dt, 23) between #{start_date} and #{end_date}
				group by	
					build_seq , convert(char(10), tb_owner.mod_dt , 23)
			), temp as (
				select 
					  dt
					, isnull(owner_join.build_seq, owner_leave.build_seq) as build_seq
					, owner_join.join_cnt
					, owner_join_dt
					, pre_owner
					, owner_leave.leave_cnt
					, owner_leave_dt
				from 
					A
				left outer join owner_join
					on owner_join_dt = dt
				left join owner_leave
					on owner_leave_dt = dt
			), stat as (
				select 
					 convert(char(10), dt, 23) as dt
					, build_seq
					, isnull(sum(join_cnt),0) as join_cnt
					, isnull(sum(pre_owner),0) as pre_owner
					, isnull(sum(leave_cnt),0) as leave_cnt
				from 
					temp where build_seq != ''
				group by 
					convert(char(10), dt, 23) , build_seq 
			), cnt as (
				select
					build_seq
			  	 , count(ho_cnt) as ho_cnt
				from
					(
						select 
						  build_seq 
						, count(store_ho) as ho_cnt 
						from 
							tb_owner 
						where 
							owner_status !=4  
						group by 
							build_seq, store_ho
						) ss
					group by 
						build_seq
			), page as (
				select 
					  row_number () over(order by dt desc) as row_num
					, dt
					, tb_build.build_name
					, join_cnt
					, pre_owner
					, leave_cnt
					, tb_sido.sido_name
					, tb_sigungu.sigungu_name
					, tb_dong.dong_name
					, cnt.ho_cnt
				from 
					stat
				inner join tb_build
					on stat.build_seq = tb_build.build_seq 
					and tb_build.del_flag = 'N'
				inner join tb_dong
					on tb_dong.dong_seq = tb_build.dong_seq 
					and tb_dong.del_flag = 'N'
				inner join tb_sigungu
					on tb_sigungu.sigungu_seq = tb_dong.sigungu_seq 
					and tb_sigungu.del_flag = 'N'
				inner join tb_sido
					on tb_sigungu.sido_seq = tb_sido.sido_seq 
					and tb_sido.del_flag = 'N'	
				inner join cnt
					on stat.build_seq = cnt.build_seq	
				
			]]>
			<if test="type == 'search'">
				<if test="sido_seq != null">
					<![CDATA[
						and tb_sido.sido_seq = #{sido_seq}
					]]>
				</if>
		
				<if test="sigungu_seq != null">
					<![CDATA[
						and tb_sigungu.sigungu_seq = #{sigungu_seq}
					]]>
				</if>
		
				<if test="dong_seq != null">
					<![CDATA[
						and tb_dong.dong_seq = #{dong_seq}
					]]>
				</if>
			</if>
			<if test="admin_grade == 3">
					and tb_build.build_seq in (select tb_admin_grade.build_seq from tb_admin_grade where tb_admin_grade.admin_id = #{admin_id} and tb_admin_grade.del_flag = 'N')
			</if>	
			)
			select
				*
			from
				page
			where
				row_num between #{start_num} and #{end_num}
			option (maxrecursion 0)		
		</if>	
	</select>
	
	<select id="getCouponTotalCount" parameterType="honeyarcade.admin.im.data.AdminImDataVO" resultType="Integer">
	<if test="dateType == 1">
	
		select
			count(coupon_used_cnt) as cnt
		from
			(
				select
					  convert(char(7), coupon_used_dt, 23) as coupon_used_cnt
				from tb_sido
				inner join tb_sigungu 
					on tb_sido.sido_seq = tb_sigungu.sido_seq 
					and tb_sigungu.DEL_FLAG = 'N'
				inner join tb_dong
					on tb_dong.sigungu_seq = tb_sigungu.sigungu_seq 
					and tb_dong.DEL_FLAG ='N'
				inner join tb_build
					on tb_dong.dong_seq = tb_build.dong_seq 
					and tb_build.del_flag ='N'
				inner join tb_owner
					on tb_build.build_seq = tb_owner.build_seq 
				inner join tb_coupon
					on tb_coupon.owner_id = tb_owner.owner_id 
				inner join tb_user_coupon 
					on tb_user_coupon.coupon_seq = tb_coupon.coupon_seq 
				where
					tb_owner.owner_status != 4
					and tb_user_coupon.coupon_used_flag = 'Y'
					and coupon_used_dt between #{start_date} and #{end_date}
				<if test="admin_grade == 3">
					and tb_build.build_seq in (select tb_admin_grade.build_seq from tb_admin_grade where tb_admin_grade.admin_id = #{admin_id} and tb_admin_grade.del_flag = 'N')
				</if>	
				<if test="type == 'search'">
					<if test="sido_seq != null">
						<![CDATA[
							and tb_sido.sido_seq = #{sido_seq}
						]]>
					</if>
			
					<if test="sigungu_seq != null">
						<![CDATA[
							and tb_sigungu.sigungu_seq = #{sigungu_seq}
						]]>
					</if>
			
					<if test="dong_seq != null">
						<![CDATA[
							and tb_dong.dong_seq = #{dong_seq}
						]]>
					</if>
				</if>	
				group by
					convert(char(7), coupon_used_dt, 23),  tb_sido.sido_name,  tb_sigungu.sigungu_name, tb_dong.dong_name, tb_build.build_name, tb_owner.store_name
			) t
	
	</if>
	<if test="dateType == 2">
	
		select
			count(coupon_used_cnt) as cnt
		from
			(
				select
					  convert(char(10), coupon_used_dt, 23) as coupon_used_cnt
				from tb_sido
				inner join tb_sigungu 
					on tb_sido.sido_seq = tb_sigungu.sido_seq 
					and tb_sigungu.DEL_FLAG = 'N'
				inner join tb_dong
					on tb_dong.sigungu_seq = tb_sigungu.sigungu_seq 
					and tb_dong.DEL_FLAG ='N'
				inner join tb_build
					on tb_dong.dong_seq = tb_build.dong_seq 
					and tb_build.del_flag ='N'
				inner join tb_owner
					on tb_build.build_seq = tb_owner.build_seq 
				inner join tb_coupon
					on tb_coupon.owner_id = tb_owner.owner_id 
				inner join tb_user_coupon 
					on tb_user_coupon.coupon_seq = tb_coupon.coupon_seq 
				where
					tb_owner.owner_status != 4
					and tb_user_coupon.coupon_used_flag = 'Y'
					and coupon_used_dt between #{start_date} and #{end_date}
				<if test="admin_grade == 3">
					and tb_build.build_seq in (select tb_admin_grade.build_seq from tb_admin_grade where tb_admin_grade.admin_id = #{admin_id} and tb_admin_grade.del_flag = 'N')
				</if>						
				<if test="type == 'search'">
					<if test="sido_seq != null">
						<![CDATA[
							and tb_sido.sido_seq = #{sido_seq}
						]]>
					</if>
			
					<if test="sigungu_seq != null">
						<![CDATA[
							and tb_sigungu.sigungu_seq = #{sigungu_seq}
						]]>
					</if>
			
					<if test="dong_seq != null">
						<![CDATA[
							and tb_dong.dong_seq = #{dong_seq}
						]]>
					</if>
				</if>					
				group by
					convert(char(10), coupon_used_dt, 23),  tb_sido.sido_name,  tb_sigungu.sigungu_name, tb_dong.dong_name, tb_build.build_name, tb_owner.store_name
			) t	
	
	</if>
	</select>
	
	<select id="getCouponList" parameterType="honeyarcade.admin.im.data.AdminImDataVO" resultType="honeyarcade.admin.im.data.AdminImDataVO">
	<if test="dateType == 1">
	
		select
			*
		from
			(
				select
					  row_number () over (order by convert(char(7), coupon_used_dt, 23) desc) as row_num
					, sido_name
					, sigungu_name
					, dong_name
					, build_name
					, store_name
					, convert(char(7), coupon_used_dt, 23) as coupon_used_dt 
					, count(case when tb_user_coupon.coupon_used_flag = 'Y' then 1 end) as coupon_used_cnt
				from 
					tb_sido
				inner join tb_sigungu 
					on tb_sido.sido_seq = tb_sigungu.sido_seq 
					and tb_sigungu.DEL_FLAG = 'N'
				inner join tb_dong
					on tb_dong.sigungu_seq = tb_sigungu.sigungu_seq 
					and tb_dong.DEL_FLAG ='N'
				inner join tb_build
					on tb_dong.dong_seq = tb_build.dong_seq 
					and tb_build.del_flag ='N'
				inner join tb_owner
					on tb_build.build_seq = tb_owner.build_seq 
				inner join tb_coupon
					on tb_coupon.owner_id = tb_owner.owner_id 
				inner join tb_user_coupon 
					on tb_user_coupon.coupon_seq = tb_coupon.coupon_seq 
				where
					tb_owner.owner_status != 4
					and tb_user_coupon.coupon_used_flag = 'Y'
					and coupon_used_dt between #{start_date} and #{end_date}
				<if test="admin_grade == 3">
					and tb_build.build_seq in (select tb_admin_grade.build_seq from tb_admin_grade where tb_admin_grade.admin_id = #{admin_id} and tb_admin_grade.del_flag = 'N')
				</if>	
				<if test="type == 'search'">
					<if test="sido_seq != null">
						<![CDATA[
							and tb_sido.sido_seq = #{sido_seq}
						]]>
					</if>
						
					<if test="sigungu_seq != null">
						<![CDATA[
							and tb_sigungu.sigungu_seq = #{sigungu_seq}
						]]>
					</if>
				
					<if test="dong_seq != null">
						<![CDATA[
							and tb_dong.dong_seq = #{dong_seq}
						]]>
					</if>
				</if>					
				group by
					convert(char(7), coupon_used_dt, 23),  tb_sido.sido_name,  tb_sigungu.sigungu_name, tb_dong.dong_name, tb_build.build_name, tb_owner.store_name			
			) t
		where
			row_num between #{start_num} and #{end_num}
			
	
	</if>
	<if test="dateType == 2">
	
		select
			*
		from
			(
				select
					  row_number () over (order by convert(char(10), coupon_used_dt, 23) desc) as row_num
					, sido_name
					, sigungu_name
					, dong_name
					, build_name
					, store_name
					, convert(char(10), coupon_used_dt, 23) as coupon_used_dt 
					, count(case when tb_user_coupon.coupon_used_flag = 'Y' then 1 end) as coupon_used_cnt
				from 
					tb_sido
				inner join tb_sigungu 
					on tb_sido.sido_seq = tb_sigungu.sido_seq 
					and tb_sigungu.DEL_FLAG = 'N'
				inner join tb_dong
					on tb_dong.sigungu_seq = tb_sigungu.sigungu_seq 
					and tb_dong.DEL_FLAG ='N'
				inner join tb_build
					on tb_dong.dong_seq = tb_build.dong_seq 
					and tb_build.del_flag ='N'
				inner join tb_owner
					on tb_build.build_seq = tb_owner.build_seq 
				inner join tb_coupon
					on tb_coupon.owner_id = tb_owner.owner_id 
				inner join tb_user_coupon 
					on tb_user_coupon.coupon_seq = tb_coupon.coupon_seq 
				where
					tb_owner.owner_status != 4
					and tb_user_coupon.coupon_used_flag = 'Y'
					and coupon_used_dt between #{start_date} and #{end_date}
				<if test="admin_grade == 3">
					and tb_build.build_seq in (select tb_admin_grade.build_seq from tb_admin_grade where tb_admin_grade.admin_id = #{admin_id} and tb_admin_grade.del_flag = 'N')
				</if>						
				<if test="type == 'search'">
					<if test="sido_seq != null">
						<![CDATA[
							and tb_sido.sido_seq = #{sido_seq}
						]]>
					</if>
				
					<if test="sigungu_seq != null">
						<![CDATA[
							and tb_sigungu.sigungu_seq = #{sigungu_seq}
						]]>
					</if>
				
					<if test="dong_seq != null">
						<![CDATA[
							and tb_dong.dong_seq = #{dong_seq}
						]]>
					</if>
				</if>					
				group by
					convert(char(10), coupon_used_dt, 23),  tb_sido.sido_name,  tb_sigungu.sigungu_name, tb_dong.dong_name, tb_build.build_name, tb_owner.store_name			
			) t
		where
			row_num between #{start_num} and #{end_num}
	
	</if>
	</select>

</mapper>