<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="honeyarcade.admin.im.sales.AdminImSalesMapper">
	
	<select id="getTotalCount" parameterType="honeyarcade.admin.im.sales.AdminImSalesVO" resultType="honeyarcade.admin.im.sales.AdminImSalesVO">
		<if test = "dateType == 1">
		<![CDATA[
			select 
				  count(*) as totalCount
				, sum(sum_money) as totalPrice
			from 
				(
					select  
						  member_id
						, sum(pay_money) as sum_money
						, pay_ym
						, pay_day
						, count(member_id) as pay_cnt
					from 
						(
							select
								tb_pay.pay_money
								, tb_member.member_id
								, substring(convert (char(10), pay_dt, 23), 9, 10) as pay_day
								, substring(convert (char(10), pay_dt, 23), 1, 7) as pay_ym
							from tb_pay
								inner join tb_owner
									on tb_pay.owner_id = tb_owner.owner_id
									and owner_status != 4
								inner join tb_member
									on tb_member.owner_id = tb_owner.owner_id
							where
								substring(convert (char(10), pay_dt, 23), 1, 4)  = #{year} 
						)a
					group by 
						member_id, pay_ym, pay_day
				)b
		]]>
		</if>
		<if test = "dateType == 2">
		<![CDATA[
			select 
				  count(*) as totalCount
				, sum(sum_money) as totalPrice
			from 
				(
					select  
						  member_id
						, sum(pay_money) as sum_money
						, pay_ym
						, pay_day
						, count(member_id) as pay_cnt
					from 
						(
							select
								tb_pay.pay_money
								, tb_member.member_id
								, substring(convert (char(10), pay_dt, 23), 9, 10) as pay_day
								, substring(convert (char(10), pay_dt, 23), 1, 7) as pay_ym
							from tb_pay
								inner join tb_owner
									on tb_pay.owner_id = tb_owner.owner_id
									and owner_status != 4
								inner join tb_member
									on tb_member.owner_id = tb_owner.owner_id
							where
								substring(convert (char(10), pay_dt, 23), 1, 7)  = concat(#{year},'-',#{month}) 
						)a
					group by 
						member_id, pay_ym, pay_day
				)b			
		]]>	
		</if>
	</select>
	
	<select id="getStatList" parameterType="honeyarcade.admin.im.sales.AdminImSalesVO" resultType="honeyarcade.admin.im.sales.AdminImSalesVO">
		<if test = "dateType == 1">
		<![CDATA[
			select
				*
			from
				(
					select 
						  row_number () over(order by pay_ym desc , pay_day desc) as row_num
						, member_id
						, sum(pay_money) as sum_money
						, pay_ym
						, pay_day
						, build_name
						, dong_name
						, sigungu_name
						, sido_name
						, store_name
					from 
						(
							select
								  tb_pay.pay_money
								, tb_member.member_id
								, substring(convert (char(10), pay_dt, 23), 9, 10) as pay_day
								, substring(convert (char(10), pay_dt, 23), 1, 7) as pay_ym
								, tb_build.build_name 
								, tb_dong.dong_name 
								, tb_sigungu.sigungu_name 
								, tb_sido.sido_name
								, tb_owner.store_name 
							from tb_pay
								inner join tb_owner
									on tb_pay.owner_id = tb_owner.owner_id
									and owner_status != 4
								inner join tb_member
									on tb_member.owner_id = tb_owner.owner_id	
								inner join tb_build
									on tb_owner.build_seq = tb_build.build_seq
								inner join tb_dong
									on tb_dong.dong_seq = tb_build.dong_seq 
								inner join tb_sigungu
									on tb_sigungu.sigungu_seq = tb_dong.sigungu_seq 
								inner join tb_sido
									on tb_sido.sido_seq = tb_sigungu.sido_seq 
							where
								substring(convert (char(10), pay_dt, 23), 1, 4)  = #{year}
							)a
					group by 
						sido_name, sigungu_name, dong_name, build_name, pay_ym, pay_day, member_id, store_name
				)b
			where
				row_num between #{start_num} and #{end_num}
		]]>	
		</if>
		<if test = "dateType == 2">
		<![CDATA[
			select
				*
			from
				(
					select 
						  row_number () over(order by pay_ym desc , pay_day desc) as row_num
						, member_id
						, sum(pay_money) as sum_money
						, pay_ym
						, pay_day
						, build_name
						, dong_name
						, sigungu_name
						, sido_name
						, store_name
					from 
						(
							select
								  tb_pay.pay_money
								, tb_member.member_id
								, substring(convert (char(10), pay_dt, 23), 9, 10) as pay_day
								, substring(convert (char(10), pay_dt, 23), 1, 7) as pay_ym
								, tb_build.build_name 
								, tb_dong.dong_name 
								, tb_sigungu.sigungu_name 
								, tb_sido.sido_name 
								, tb_owner.store_name
							from tb_pay
								inner join tb_owner
									on tb_pay.owner_id = tb_owner.owner_id
									and owner_status != 4
								inner join tb_member
									on tb_member.owner_id = tb_owner.owner_id	
								inner join tb_build
									on tb_owner.build_seq = tb_build.build_seq
								inner join tb_dong
									on tb_dong.dong_seq = tb_build.dong_seq 
								inner join tb_sigungu
									on tb_sigungu.sigungu_seq = tb_dong.sigungu_seq 
								inner join tb_sido
									on tb_sido.sido_seq = tb_sigungu.sido_seq 
							where
								substring(convert (char(10), pay_dt, 23), 1, 7)  = concat(#{year},'-',#{month})
							)a
					group by 
						sido_name, sigungu_name, dong_name, build_name, pay_ym, pay_day, member_id, store_name
				)b
			where
				row_num between #{start_num} and #{end_num}
		]]>	
		</if>
	</select>
</mapper>