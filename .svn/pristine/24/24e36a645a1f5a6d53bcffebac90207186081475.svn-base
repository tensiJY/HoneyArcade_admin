<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="honeyarcade.admin.member.owner.AdminMemberOwnerMapper">
	
	<select id="getOwnerTypeCount" resultType="honeyarcade.admin.member.owner.AdminMemberOwnerVO">
		select 
			count(owner_id) as 'total_owner'
			, count(case when owner_type = 1 then 1 end) as free_owner
			, count(case when owner_type = 2 then 1 end) as pre_owner
			, count(case when owner_type = 3 then 1 end) as exp_owner
		from
			(
				select
					tb_owner.owner_id
					 , case when used_money is null then 1 
					  when total_count - used_coupon ! = 0 then 2
					  else 3 end as 'owner_type'
				from 
					tb_sido 
				inner join tb_sigungu
					on tb_sido.sido_seq = tb_sigungu.sido_seq 
					and tb_sigungu.del_flag ='N'
				inner join tb_dong
					on tb_sigungu.sigungu_seq  = tb_dong.sigungu_seq 
					and tb_dong.del_flag ='N'
				inner join tb_build
					on tb_build.dong_seq = tb_dong.dong_seq
				inner join tb_owner 
					on tb_build.build_seq = tb_owner.build_seq 
					and tb_owner.owner_status != 4
				inner join tb_member
					on tb_member.owner_id = tb_owner.owner_id					
				left outer join (
									select 
										tb_pay.owner_id 
										, count(tb_pay_dtl.pay_seq) as total_count
										, count(case when tb_pay_dtl.pay_dtl_use = 5 then 1 end) as used_coupon
									from 
										tb_pay
									inner join tb_pay_dtl 
										on tb_pay.pay_seq = tb_pay_dtl.pay_seq 
									group by
										tb_pay.owner_id 	
								)t
					on tb_owner.owner_id = t.owner_id
				left outer join (
									select 
										owner_id
									  , sum(pay_money) as used_money 
									from 
										tb_pay group by owner_id
								)s	
					on tb_owner.owner_id = s.owner_id				
				where	
					tb_sido.del_flag = 'N'
					<if test="type == 'search'">
						<if test="sido_seq != null">
						<![CDATA[
							and tb_sido.sido_seq = #{sido_seq}
						]]>
						</if>
								
						<if test="sigungu_seq != null">
						<![CDATA[
							and tb_sigungu.sigungu_seq = #{sigungu_seq}
						]]>
						</if>
								
						<if test="dong_seq != null">
						<![CDATA[
							and tb_dong.dong_seq = #{dong_seq}
						]]>
						</if>
						
						<if test="build_seq != null">
						<![CDATA[
							and tb_build.build_seq = #{build_seq}
						]]>
						</if>
						
						<if test="search_text != null || search_text != ''">
						<![CDATA[
							and 
								( 1 = 1
									and
										tb_sido.sido_name like '%'+ #{search_text} + '%'
									or
										tb_sigungu.sigungu_name like '%'+ #{search_text} +'%'
									or 
										tb_dong.dong_name like '%'+ #{search_text} + '%'
									or
										tb_build.build_name like '%'+ #{search_text} + '%'	
									or 
										tb_owner.store_name like '%'+ #{search_text} + '%'	
									or
										tb_member.member_id like '%'+ #{search_text} + '%'
								)
						]]>
						</if>
					</if>						
			) a
	</select>
	
	<select id="getTotalCount" parameterType="honeyarcade.admin.member.owner.AdminMemberOwnerVO" resultType="Integer">
	select
		count(*) as total_count
	from (
		select
			tb_owner.owner_id
			 , case when used_money is null then 1 
			  when total_count - used_coupon ! = 0 then 2
			  else 3 end as 'owner_type'
		from 
			tb_sido 
		inner join tb_sigungu
			on tb_sido.sido_seq = tb_sigungu.sido_seq 
			and tb_sigungu.del_flag ='N'
		inner join tb_dong
			on tb_sigungu.sigungu_seq  = tb_dong.sigungu_seq 
			and tb_dong.del_flag ='N'
		inner join tb_build
			on tb_build.dong_seq = tb_dong.dong_seq
		inner join tb_owner 
			on tb_build.build_seq = tb_owner.build_seq
			and tb_owner.owner_status != 4 
		inner join tb_member
			on tb_member.owner_id = tb_owner.owner_id			
		left outer join (
							select 
								tb_pay.owner_id 
								, count(tb_pay_dtl.pay_seq) as total_count
								, count(case when tb_pay_dtl.pay_dtl_type=1 and tb_pay_dtl.pay_dtl_use !=5 then 1 end) as remain_build
								, count(case when tb_pay_dtl.pay_dtl_type=2 and tb_pay_dtl.pay_dtl_use !=5 then 1 end) as remain_area
								, count(case when tb_pay_dtl.pay_dtl_type=3 and tb_pay_dtl.pay_dtl_use !=5 then 1 end) as remain_coupon
								, count(case when tb_pay_dtl.pay_dtl_use = 5 then 1 end) as used_coupon
							from 
								tb_pay
							inner join tb_pay_dtl 
								on tb_pay.pay_seq = tb_pay_dtl.pay_seq 
							group by
								tb_pay.owner_id 	
						)t
			on tb_owner.owner_id = t.owner_id
			left outer join (
									select 
										owner_id
									  , sum(pay_money) as used_money 
									from 
										tb_pay group by owner_id
								)s	
			on tb_owner.owner_id = s.owner_id					
		where	
			tb_sido.del_flag = 'N'
		<if test="type == 'search'">
			<if test="sido_seq != null">
			<![CDATA[
				and tb_sido.sido_seq = #{sido_seq}
			]]>
			</if>
					
			<if test="sigungu_seq != null">
			<![CDATA[
				and tb_sigungu.sigungu_seq = #{sigungu_seq}
			]]>
			</if>
					
			<if test="dong_seq != null">
			<![CDATA[
				and tb_dong.dong_seq = #{dong_seq}
			]]>
			</if>
			
			<if test="build_seq != null">
			<![CDATA[
				and tb_build.build_seq = #{build_seq}
			]]>
			</if>
			
			<if test="search_text != null || search_text != ''">
			<![CDATA[
				and 
					( 1 = 1
						and
							tb_sido.sido_name like '%'+ #{search_text} + '%'
						or
							tb_sigungu.sigungu_name like '%'+ #{search_text} +'%'
						or 
							tb_dong.dong_name like '%'+ #{search_text} + '%'
						or
							tb_build.build_name like '%'+ #{search_text} + '%'	
						or 
							tb_owner.store_name like '%'+ #{search_text} + '%'
						or
							tb_member.member_id like '%'+ #{search_text} + '%'							
					)
			]]>
			</if>
		</if>			
	)a
	<if test="type == 'search'">
		<if test="owner_type != 0">
			where
				owner_type = #{owner_type}
		</if>
	</if>
	
	</select>
	
	
	<select id="getOwnerList" parameterType="honeyarcade.admin.member.owner.AdminMemberOwnerVO" resultType="honeyarcade.admin.member.owner.AdminMemberOwnerVO">
	select
		*
	from
		(select 
			<if test="sort_date_type == 1">
				row_number () over (order by owner_join_dt desc) as row_num
			</if>
			<if test="sort_date_type == 2">
				row_number () over (order by owner_join_dt) as row_num
			</if>
			, *
		from 
			(select
				tb_build.build_name 
				, tb_owner.owner_id 
				, tb_owner.store_name
				, used_money as used_money
				, remain_build
				, remain_area
				, remain_coupon
				, case when used_money is null then 1 
				  when total_count - used_coupon ! = 0 then 2
				  else 3 end as 'owner_type'
				, tb_owner.owner_status  
				, tb_dong.dong_name
				, tb_member.member_id
				, tb_member.owner_join_dt
			from 
				tb_sido 
			inner join tb_sigungu
				on tb_sido.sido_seq = tb_sigungu.sido_seq 
				and tb_sigungu.del_flag ='N'
			inner join tb_dong
				on tb_sigungu.sigungu_seq  = tb_dong.sigungu_seq 
				and tb_dong.del_flag ='N'
			inner join tb_build
				on tb_build.dong_seq = tb_dong.dong_seq
			inner join tb_owner 
				on tb_build.build_seq = tb_owner.build_seq 
				and tb_owner.owner_status != 4
			inner join tb_member
				on tb_member.owner_id = tb_owner.owner_id	
			left outer join (
								select 
									tb_pay.owner_id 
									, count(tb_pay_dtl.pay_seq) as total_count
									, count(case when tb_pay_dtl.pay_dtl_type=1 and tb_pay_dtl.pay_dtl_use !=5 then 1 end) as remain_build
									, count(case when tb_pay_dtl.pay_dtl_type=2 and tb_pay_dtl.pay_dtl_use !=5 then 1 end) as remain_area
									, count(case when tb_pay_dtl.pay_dtl_type=3 and tb_pay_dtl.pay_dtl_use !=5 then 1 end) as remain_coupon
									, count(case when tb_pay_dtl.pay_dtl_use = 5 then 1 end) as used_coupon
								from 
									tb_pay
								inner join tb_pay_dtl 
									on tb_pay.pay_seq = tb_pay_dtl.pay_seq 
								group by
									tb_pay.owner_id 	
							)t
								on tb_owner.owner_id = t.owner_id
			left outer join (
									select 
										owner_id
									  , sum(pay_money) as used_money 
									from 
										tb_pay group by owner_id
								)s	
			on tb_owner.owner_id = s.owner_id									
			where
				tb_sido.del_flag = 'N'
			<if test="type == 'search'">
				<if test="sido_seq != null">
				<![CDATA[
					and tb_sido.sido_seq = #{sido_seq}
				]]>
				</if>
						
				<if test="sigungu_seq != null">
				<![CDATA[
					and tb_sigungu.sigungu_seq = #{sigungu_seq}
				]]>
				</if>
						
				<if test="dong_seq != null">
				<![CDATA[
					and tb_dong.dong_seq = #{dong_seq}
				]]>
				</if>
				
				<if test="build_seq != null">
				<![CDATA[
					and tb_build.build_seq = #{build_seq}
				]]>
				</if>
				
				<if test="search_text != null || search_text != ''">
				<![CDATA[
					and 
						( 1 = 1
							and
								tb_sido.sido_name like '%'+ #{search_text} + '%'
							or
								tb_sigungu.sigungu_name like '%'+ #{search_text} +'%'
							or 
								tb_dong.dong_name like '%'+ #{search_text} + '%'
							or
								tb_build.build_name like '%'+ #{search_text} + '%'	
							or 
								tb_owner.store_name like '%'+ #{search_text} + '%'
							or
								tb_member.member_id like '%'+ #{search_text} + '%'								
						)
				]]>
				</if>
			</if>					
		)s
		<if test="type == 'search'">
			<if test="owner_type != 0">
				where
					owner_type = #{owner_type}
			</if>
		</if>
	)a
	where
		row_num between #{start_num} and #{end_num}
	</select>
	
	<select id="getOwnerInfo" parameterType="honeyarcade.admin.member.owner.AdminMemberOwnerVO" resultType="honeyarcade.admin.member.owner.AdminMemberOwnerVO">
	<![CDATA[
		select
			  tb_sido.sido_seq
			, tb_sigungu.sigungu_seq
			, tb_dong.dong_seq
			, tb_build.build_seq
			, tb_owner.owner_id 
			, tb_owner.store_name 
			, tb_owner.store_sort 
			, tb_owner.store_ho
			, tb_owner.store_status
			, tb_owner.del_flag
			, tb_owner.lcate_seq 
			, tb_owner.mcate_seq 
			, tb_owner.owner_email
			, tb_owner.owner_phone
			, tb_owner.store_floor
			, tb_owner.store_link
			, tb_owner.store_keyword
			, tb_owner.store_text
			, tb_owner.busi_reg_file_seq
			, tb_owner.main_file_seq
			, tb_owner.owner_status
			, tb_owner.pro_file_seq
			, tb_member.member_id
		from 
			tb_sido 
		inner join tb_sigungu
			on tb_sido.sido_seq = tb_sigungu.sido_seq 
			and tb_sigungu.del_flag ='N'
		inner join tb_dong
			on tb_sigungu.sigungu_seq  = tb_dong.sigungu_seq 
			and tb_dong.del_flag ='N'
		inner join tb_build
			on tb_build.dong_seq = tb_dong.dong_seq
		inner join tb_owner 
			on tb_build.build_seq = tb_owner.build_seq
		inner join tb_member
			on tb_member.owner_id = tb_owner.owner_id			
		where
			tb_owner.owner_id = #{owner_id}
	]]>
	</select>
	
	<select id="getProductList" parameterType="honeyarcade.admin.member.owner.AdminMemberOwnerVO" resultType="honeyarcade.admin.member.owner.AdminMemberOwnerVO">
	<![CDATA[
		select 
			product_seq 
			, product_name 
			, product_price 
			, tb_product.file_seq 
			, tb_file_dtl.file_type 
			, tb_file_dtl.file_dtl_path 
			, tb_file_dtl.file_dtl_desc 
			, tb_file_dtl.file_dtl_origin 
			, tb_file_dtl.file_dtl_ext 
			, tb_file_dtl.file_dtl_url_path 
		from tb_product
		inner join tb_file 
			on tb_product.file_seq = tb_file.file_seq
			and tb_file.del_flag = 'N'
		left outer join tb_file_dtl
			on tb_product.file_seq = tb_file_dtl.file_seq 
		where
			tb_product.owner_id = #{owner_id}
	]]>
	</select>

	<select id="getOpenDay" parameterType="honeyarcade.admin.member.owner.AdminMemberOwnerVO" resultType="honeyarcade.admin.member.owner.AdminMemberOwnerVO">
	<![CDATA[
		select  
			  open_day
			, open_time
			, close_time
			, case when open_day = 1 then '주중' 
				when open_day = 2 then '주말' 
				when open_day = 3 then '월~토'
				when open_day = 4 then '월'
				when open_day = 5 then '화'
				when open_day = 6 then '수' 
				when open_day = 7 then '목' 
				when open_day = 8 then '금'
				when open_day = 9 then '토'
				when open_day = 10 then '일' 
				when open_day = 11 then '해당 사항 없음' end as 'open_day_text'
		from tb_open 
			where 
				tb_open.owner_id = #{owner_id}
	]]>
	</select>	
	
	<select id="getBreakDay" parameterType="honeyarcade.admin.member.owner.AdminMemberOwnerVO" resultType="honeyarcade.admin.member.owner.AdminMemberOwnerVO">
	<![CDATA[
		select  
			  break_day
			, open_time
			, close_time
			, case  when break_day = 1 then '주중' 
					when break_day = 2 then '주말' 
					when break_day = 3 then '월~토'
					when break_day = 4 then '월'
					when break_day = 5 then '화'
					when break_day = 6 then '수' 
					when break_day = 7 then '목' 
					when break_day = 8 then '금'
					when break_day = 9 then '토'
					when break_day = 10 then '일' 
					when break_day = 11 then '해당 사항 없음' 
				end as 'break_day_text'
		from tb_break 
			where 
				tb_break.owner_id = #{owner_id}
	]]>
	</select>	
	
	<update id="acceptProc" parameterType="honeyarcade.admin.member.owner.AdminMemberOwnerVO">
	<![CDATA[
		update
			tb_owner
		set
			owner_status = 2		
		where
			owner_id = #{owner_id}
	]]>
	</update>	
	
	
	<select id="getDayOffList" parameterType="honeyarcade.admin.member.owner.AdminMemberOwnerVO" resultType="honeyarcade.admin.member.owner.AdminMemberOwnerVO">
	<![CDATA[
		select  
			  day_off_week
			, day_off_day 
			, case  when day_off_week = 'A' then '매주' 
					when day_off_week = 1 then '첫째주' 
					when day_off_week = 2 then '둘째주'
					when day_off_week = 3 then '셋째주'
					when day_off_week = 4 then '넷째주'
					when day_off_week = 5 then '마지막주'
				end as 'week_text'
			, case  when day_off_day = 0 then '일요일' 
					when day_off_day = 1 then '월요일' 
					when day_off_day = 2 then '화요일'
					when day_off_day = 3 then '수요일'
					when day_off_day = 4 then '목요일'
					when day_off_day = 5 then '금요일'
					when day_off_day = 6 then '토요일'
				end as 'day_text'				
		from 
			tb_day_off 
		where 
				tb_day_off.owner_id = #{owner_id}
	]]>
	</select>
	
	<delete id="deleteOpen" parameterType="honeyarcade.admin.member.owner.AdminMemberOwnerVO">
	<![CDATA[
		delete from tb_open
		where
			owner_id = #{owner_id}
	]]>
	</delete>

	<delete id="deleteBreak" parameterType="honeyarcade.admin.member.owner.AdminMemberOwnerVO">
	<![CDATA[
		delete from tb_break
		where
			owner_id = #{owner_id}
	]]>
	</delete>	
	
	<delete id="deleteDayOff" parameterType="honeyarcade.admin.member.owner.AdminMemberOwnerVO">
	<![CDATA[
		delete from tb_day_off
		where
			owner_id = #{owner_id}
	]]>
	</delete>		

	<delete id="deleteProduct" parameterType="honeyarcade.admin.member.owner.AdminMemberOwnerVO">
	<![CDATA[
		delete from tb_product
		where
			owner_id = #{owner_id}
	]]>
	</delete>		
	
	<insert id="insertOpen" parameterType="honeyarcade.admin.member.owner.AdminMemberOwnerVO">
	<![CDATA[
		insert into tb_open
			(
				  open_day
				, owner_id
				, open_time
				, close_time
			)
		values
			(
				  #{open_day}
				, #{owner_id}
				, #{open_time}
				, #{close_time}
			)
	]]>
	</insert>	
	
	<insert id="insertBreak" parameterType="honeyarcade.admin.member.owner.AdminMemberOwnerVO">
	<![CDATA[
		insert into tb_break
			(
				  break_day
				, owner_id
				, open_time
				, close_time
			)
		values
			(
				  #{break_day}
				, #{owner_id}
				, #{open_time}
				, #{close_time}
			)
	]]>
	</insert>	

	<insert id="insertDayOff" parameterType="honeyarcade.admin.member.owner.AdminMemberOwnerVO">
	<![CDATA[
		insert into tb_day_off
			(
				  day_off_week
				, owner_id
				, day_off_day
			)
		values
			(
				  #{day_off_week}
				, #{owner_id}
				, #{day_off_day}
			)
	]]>
	</insert>	
	
	<insert id="insertProduct" parameterType="honeyarcade.admin.member.owner.AdminMemberOwnerVO">
	<![CDATA[
		insert into tb_product
			(
				  product_seq
				, owner_id
				, product_name
				, product_price
				, file_seq
			)
		values
			(
				  #{product_seq}
				, #{owner_id}
				, #{product_name}
				, #{product_price}
				, #{file_seq}
			)
	]]>
	</insert>
	
	<update id="updateOwner" parameterType="honeyarcade.admin.member.owner.AdminMemberOwnerVO">
	<![CDATA[
		update
			tb_owner
		set
			  mod_dt 			= getDate()
			, mod_id 			= #{admin_id}
			, owner_email 		= #{owner_email}
			, build_seq			= #{build_seq}
			, owner_phone		= #{owner_phone}
			, busi_reg_file_seq = #{busi_reg_file_seq} 
			, store_name		= #{store_name}
			, store_sort		= #{store_sort}
			, store_keyword		= #{store_keyword}
			, store_text		= #{store_text}
			, lcate_seq			= #{lcate_seq}
			, mcate_seq			= #{mcate_seq}
			, store_link		= #{store_link}
			, main_file_seq		= #{main_file_seq}
			, pro_file_seq		= #{pro_file_seq}
		where
			owner_id = #{owner_id}
	]]>
	</update>	
	
	<update id="statusProc" parameterType="honeyarcade.admin.member.owner.AdminMemberOwnerVO">
	<![CDATA[
		update
			tb_owner
		set
			  mod_dt 			= getDate()
			, mod_id 			= #{mod_id}
			, del_flag			= #{del_flag}
		where
			owner_id = #{owner_id}
	]]>
	</update>	
	
	<update id="rejectProc" parameterType="honeyarcade.admin.member.owner.AdminMemberOwnerVO">
	<![CDATA[
		update
			tb_owner
		set
			  mod_dt	= getDate()
			, mod_id	= #{admin_id}
			, owner_status = 3
		where
			owner_id = #{owner_id} 
	]]>
	</update>
		
	<update id="updateMemberFlag" parameterType="honeyarcade.admin.member.owner.AdminMemberOwnerVO">
	<![CDATA[
		update
			tb_member
		set
			del_flag			= #{del_flag}
		where
			owner_id = #{owner_id}
	]]>
	</update>		
		
</mapper>